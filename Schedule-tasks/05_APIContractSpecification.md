# API Contract Specification
## Maya — Task & Scheduling API Reference

| Document Details | |
| :--- | :--- |
| **Project** | Maya Core 2.0 |
| **Module** | Scheduling & Task Management |
| **Version** | 1.0 |
| **Status** | Authoritative Reference |
| **Target Audience** | Frontend Developers, Backend Developers, QA |

---

## 1. Overview

This document specifies the API contracts for the Maya Scheduling module. It covers both the **current (Legacy)** endpoints and the **target (V3)** endpoints.

### Base URLs

| Environment | Legacy (V2) | Target (V3) |
| :--- | :--- | :--- |
| Development | `http://localhost:8000/api/v2` | `http://localhost:8000/api/v3` |
| Staging | `https://api-staging.maya.io/api/v2` | `https://api-staging.maya.io/api/v3` |
| Production | `https://api.maya.io/api/v2` | `https://api.maya.io/api/v3` |

### Authentication

All endpoints require a valid Bearer token:

```
Authorization: Bearer <access_token>
```

---

## 2. Legacy API Contracts (Current / Model 2)

These endpoints are currently in use. See `02_TechnicalAudit_ASIS.md` for implementation details.

---

### 2.1 Create Schedule

Creates a new Task Cluster.

**Endpoint:** `POST /createSchedule`

**Request Headers:**
```
Content-Type: application/json
Authorization: Bearer <token>
```

**Request Body:**
```json
{
  "task_type": "site-based",
  "idgroup": "550e8400-e29b-41d4-a716-446655440000",
  "iduser": "550e8400-e29b-41d4-a716-446655440001",
  "idsite": "550e8400-e29b-41d4-a716-446655440002",
  "idaction": "550e8400-e29b-41d4-a716-446655440003",
  "merge_key": "550e8400e29b41d4a71644665544000220251215093000",
  "createdon": "2025-12-15 00:00:00",
  "name": "Morning Mowing",
  "estimate_time": 180,
  "task_start": "2025-12-15 08:00:00",
  "task_end": "2025-12-15 11:00:00",
  "note": "Focus on greens",
  "is_am": true,
  "is_pm": false,
  "is_over_time": false,
  "areas": [
    "550e8400-e29b-41d4-a716-446655440010",
    "550e8400-e29b-41d4-a716-446655440011"
  ],
  "sub_tasks": {
    "staffs": [
      "550e8400-e29b-41d4-a716-446655440020",
      "550e8400-e29b-41d4-a716-446655440021"
    ],
    "machineries": [
      "550e8400-e29b-41d4-a716-446655440030"
    ]
  }
}
```

**Required Fields:**

| Field | Type | Description |
| :--- | :--- | :--- |
| `task_type` | string | `"site-based"` or `"tenant-based"` |
| `idgroup` | UUID | The Group (Operational Unit) ID |
| `iduser` | UUID | The creating user's ID |
| `idsite` | UUID | The Site ID |
| `idaction` | UUID | The Action ID |
| `merge_key` | string | **Generated by frontend.** Grouping key. |
| `createdon` | datetime | The schedule date |
| `name` | string | Display name |
| `estimate_time` | integer | Duration in minutes |
| `areas` | UUID[] | Array of Area/Tag IDs (required, can be empty) |
| `sub_tasks.staffs` | UUID[] | Array of Staff IDs (required, at least one) |

**Response (Success - 201):**
```json
{
  "success": true,
  "message": "Schedule created successfully",
  "data": {
    "idtask": "550e8400-e29b-41d4-a716-446655440099"
  }
}
```

**Response (Error - 422):**
```json
{
  "success": false,
  "message": "Validation failed",
  "errors": {
    "sub_tasks.staffs": ["The staffs field is required."]
  }
}
```

---

### 2.2 Update Schedule

Updates an existing Task Cluster.

**Endpoint:** `PUT /update-schedule?mergeKey={currentMergeKey}&newMergeKey={optionalNewMergeKey}`

**Query Parameters:**

| Parameter | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| `mergeKey` | string | Yes | The current merge_key of the cluster |
| `newMergeKey` | string | No | New merge_key (if scope changed) |

**Request Body:**
```json
{
  "task_type": "site-based",
  "idgroup": "550e8400-e29b-41d4-a716-446655440000",
  "idsite": "550e8400-e29b-41d4-a716-446655440002",
  "idaction": "550e8400-e29b-41d4-a716-446655440003",
  "name": "Morning Mowing",
  "task_start": "2025-12-15 08:00:00",
  "task_end": "2025-12-15 12:00:00",
  "estimate_time": 240,
  "note": "Extended session",
  "running": 0,
  "is_am": 1,
  "is_pm": 0,
  "is_over_time": 0,
  "areas": ["550e8400-e29b-41d4-a716-446655440010"],
  "sub_tasks": {
    "staffs": [
      "550e8400-e29b-41d4-a716-446655440020",
      "550e8400-e29b-41d4-a716-446655440021",
      "550e8400-e29b-41d4-a716-446655440022"
    ],
    "machineries": ["550e8400-e29b-41d4-a716-446655440030"]
  },
  "callerId": "550e8400-e29b-41d4-a716-446655440001",
  "defaultGroupId": "550e8400-e29b-41d4-a716-446655440000",
  "tenantId": "550e8400-e29b-41d4-a716-446655440050"
}
```

**Important Behaviors:**
- If `running` transitions from `0` to `1`, inventory is **deducted**.
- If `running` transitions from `1` to `0`, inventory is **refunded**.
- If `newMergeKey` is provided, `product_task` links are migrated.

**Response (Success - 200):**
```json
{
  "success": true,
  "message": "Schedule updated successfully"
}
```

---

### 2.3 Delete Schedule (By Merge Key)

Deletes an entire Task Cluster.

**Endpoint:** `DELETE /schedule/{mergeKey}`

**Path Parameters:**

| Parameter | Type | Description |
| :--- | :--- | :--- |
| `mergeKey` | string | URL-encoded merge_key |

**Response (Success - 200):**
```json
{
  "success": true,
  "message": "Schedule deleted successfully"
}
```

---

### 2.4 Delete Single Task

Deletes one parent task and its children.

**Endpoint:** `DELETE /schedule/task/{taskId}`

**Path Parameters:**

| Parameter | Type | Description |
| :--- | :--- | :--- |
| `taskId` | UUID | The parent task ID |

**Response (Success - 200):**
```json
{
  "success": true,
  "message": "Task deleted successfully"
}
```

---

### 2.5 Get Calendar Data

Fetches merged Tasks and Spraying for a date range.

**Endpoint:** `GET /schedules`

**Query Parameters:**

| Parameter | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| `idtenant` | UUID | Yes | The Tenant ID |
| `start_date` | YYYY-MM-DD | Yes | Start of date range |
| `end_date` | YYYY-MM-DD | Yes | End of date range |

**Response (Success - 200):**
```json
{
  "success": true,
  "data": {
    "2025-12-15": [
      {
        "type": "Task",
        "action_id": "550e8400-e29b-41d4-a716-446655440003",
        "action_name": "Mowing",
        "green_keepers": ["John Doe", "Jane Smith"],
        "merge_key": "...",
        "status": "planned"
      },
      {
        "type": "Spraying",
        "idspraying": "550e8400-e29b-41d4-a716-446655440060",
        "product_name": "Fertilizer X"
      }
    ]
  }
}
```

---

### 2.6 Add Products to Tasks

Links products to a Task Cluster.

**Endpoint:** `POST /tasks/products`

**Request Body:**
```json
{
  "merge_key": "550e8400e29b41d4a71644665544000220251215093000",
  "products": [
    { "idproduct": "550e8400-e29b-41d4-a716-446655440070", "quantity": 10.5 },
    { "idproduct": "550e8400-e29b-41d4-a716-446655440071", "quantity": 5.0 }
  ]
}
```

**Validation:**
- `merge_key` must exist in the `task` table.

**Response (Success - 201):**
```json
{
  "success": true,
  "message": "Products added successfully"
}
```

---

## 3. Target API Contracts (V3 / Model 3)

These endpoints represent the target architecture. See `03_TechnicalDesign_TOBE.md` for schema details.

---

### 3.1 List Tasks

Fetches tasks with optional filtering and eager loading.

**Endpoint:** `GET /api/v3/tasks`

**Query Parameters:**

| Parameter | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| `idgroup` | UUID | Yes | The Group (Operational Unit) ID |
| `start_date` | YYYY-MM-DD | No | Filter by planned_start >= |
| `end_date` | YYYY-MM-DD | No | Filter by planned_start <= |
| `type_id` | string | No | Filter by task type (e.g., `SPRAYING`) |
| `status` | string | No | Filter by status (e.g., `RUNNING`) |
| `include` | string | No | Comma-separated relations to eager load |

**Include Options:**
- `assignments` — Staff assignments
- `resources` — Machine resources
- `locations` — Sites and Holes
- `tags` — Areas/Tags
- `products` — Linked products
- `extension` — Type-specific data (e.g., Spraying calibration)

**Example Request:**
```
GET /api/v3/tasks?idgroup=abc123&start_date=2025-12-15&end_date=2025-12-15&include=assignments,locations
```

**Response (Success - 200):**
```json
{
  "data": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440099",
      "idgroup": "550e8400-e29b-41d4-a716-446655440000",
      "type_id": "GENERAL",
      "action_id": "550e8400-e29b-41d4-a716-446655440003",
      "action": { "id": "...", "name": "Mowing" },
      "title": "Morning Mowing",
      "planned_start": "2025-12-15T08:00:00Z",
      "planned_end": "2025-12-15T11:00:00Z",
      "planned_minutes": 180,
      "actual_start": null,
      "actual_end": null,
      "status": "PLANNED",
      "version": 1,
      "notes": "Focus on greens",
      "assignments": [
        { "user_id": "...", "user": { "name": "John Doe" }, "role": "LEAD" },
        { "user_id": "...", "user": { "name": "Jane Smith" }, "role": "WORKER" }
      ],
      "locations": [
        { "site_id": "...", "site": { "name": "North Course" }, "hole_id": "..." }
      ],
      "created_at": "2025-12-10T10:00:00Z"
    }
  ],
  "meta": {
    "current_page": 1,
    "total": 15,
    "per_page": 20
  }
}
```

---

### 3.2 Get Single Task

Fetches a single task with all relations.

**Endpoint:** `GET /api/v3/tasks/{id}`

**Response (Success - 200):**
```json
{
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440099",
    "idgroup": "...",
    "type_id": "GENERAL",
    "action": { "id": "...", "name": "Mowing" },
    "title": "Morning Mowing",
    "planned_start": "2025-12-15T08:00:00Z",
    "status": "PLANNED",
    "version": 1,
    "assignments": [...],
    "resources": [...],
    "locations": [...],
    "tags": [...],
    "products": [...],
    "extension": null
  }
}
```

---

### 3.3 Create Task

Creates a new task with all relations in a single request.

**Endpoint:** `POST /api/v3/tasks`

**Request Body:**
```json
{
  "idgroup": "550e8400-e29b-41d4-a716-446655440000",
  "type_id": "GENERAL",
  "action_id": "550e8400-e29b-41d4-a716-446655440003",
  "title": "Morning Mowing",
  "planned_start": "2025-12-15T08:00:00Z",
  "planned_end": "2025-12-15T11:00:00Z",
  "planned_minutes": 180,
  "notes": "Focus on greens",
  "locations": [
    { "site_id": "550e8400-e29b-41d4-a716-446655440002" }
  ],
  "tags": [
    "550e8400-e29b-41d4-a716-446655440010",
    "550e8400-e29b-41d4-a716-446655440011"
  ],
  "assignments": [
    { "user_id": "550e8400-e29b-41d4-a716-446655440020", "role": "LEAD" },
    { "user_id": "550e8400-e29b-41d4-a716-446655440021", "role": "WORKER" }
  ],
  "resources": [
    { "resource_id": "550e8400-e29b-41d4-a716-446655440030", "resource_type": "MACHINE" }
  ],
  "products": [
    { "product_id": "550e8400-e29b-41d4-a716-446655440070", "quantity": 10.5, "unit": "kg" }
  ]
}
```

**Response (Success - 201):**
```json
{
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440099",
    "status": "PLANNED",
    "version": 1,
    "created_at": "2025-12-10T10:00:00Z"
  }
}
```

---

### 3.4 Update Task

Updates an existing task with optimistic locking.

**Endpoint:** `PATCH /api/v3/tasks/{id}`

**Request Body:**
```json
{
  "version": 1,
  "status": "RUNNING",
  "actual_start": "2025-12-15T08:15:00Z",
  "assignments": [
    { "user_id": "550e8400-e29b-41d4-a716-446655440020", "role": "LEAD" },
    { "user_id": "550e8400-e29b-41d4-a716-446655440021", "role": "WORKER" },
    { "user_id": "550e8400-e29b-41d4-a716-446655440022", "role": "WORKER" }
  ]
}
```

**Optimistic Locking:**
- The `version` field in the request must match the current `version` in the database.
- If they don't match, a `409 Conflict` is returned.

**Response (Success - 200):**
```json
{
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440099",
    "status": "RUNNING",
    "version": 2,
    "updated_at": "2025-12-15T08:16:00Z"
  }
}
```

**Response (Conflict - 409):**
```json
{
  "error": "Conflict",
  "message": "The task has been modified by another user. Please refresh and try again.",
  "current_version": 2
}
```

---

### 3.5 Delete Task

Deletes a task and all its relations.

**Endpoint:** `DELETE /api/v3/tasks/{id}`

**Response (Success - 204):**
```
(No Content)
```

---

## 4. Error Codes Reference

| HTTP Code | Meaning | Common Causes |
| :--- | :--- | :--- |
| `200` | Success | Request completed successfully. |
| `201` | Created | Resource created successfully. |
| `204` | No Content | Resource deleted successfully. |
| `400` | Bad Request | Malformed JSON or invalid parameters. |
| `401` | Unauthorized | Missing or invalid Bearer token. |
| `403` | Forbidden | User lacks permission for this resource. |
| `404` | Not Found | Resource does not exist. |
| `409` | Conflict | Optimistic locking conflict (version mismatch). |
| `422` | Unprocessable Entity | Validation failed. |
| `500` | Internal Server Error | Unexpected server error. |

---

## 5. Data Types Reference

| Type | Format | Example |
| :--- | :--- | :--- |
| UUID | `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx` | `550e8400-e29b-41d4-a716-446655440000` |
| Datetime | ISO 8601 | `2025-12-15T08:00:00Z` |
| Date | `YYYY-MM-DD` | `2025-12-15` |
| Status | Enum | `DRAFT`, `PLANNED`, `RUNNING`, `COMPLETED`, `CANCELLED` |
| Type ID | String | `GENERAL`, `SPRAYING`, `LEAVE` |
| Role | String | `LEAD`, `WORKER`, `OPERATOR` |
